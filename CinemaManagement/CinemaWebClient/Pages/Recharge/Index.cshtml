@page
@model CinemaWebClient.Pages.Payment.IndexModel
@{
}

<h2 class="text-center">Request Recharge</h2>

<form style="margin: 0 auto; width:400px;">
    <div class="mb-3">
        <label class="form-label">Amount <span style="color:red;font-weight:bold">*</span></></label>
        <div class="d-flex">
            <input type="" id="amount" class="form-control" value="10,000" required style="width:90%" oninput="inputAmount()"> 
            <span style="color:red;font-weight:bold; margin-left:3%; margin-top:5px;">VND</span>
        </div>

        <div class="form-text">Input number's amount you want to recharge</div>
    </div>
    <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea id="w3review" name="w3review" rows="4" cols="50" 
            placeholder="Input description of the deposit"
            class="form-control"
        >

        </textarea>
    </div>
    <button type="button" class="btn btn-primary" onclick="payButtonClick()" style="font-weight: normal;" data-bs-toggle="modal" data-bs-target="#qrInfoModal">
        Submit
    </button>
</form>


<!-- Modal -->
<div class="modal fade" id="qrInfoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Payment</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qrCode"></div>
                <ul style="display: block; margin-left: auto; margin-right: auto; width: 50%;">
                    <li>Số tiền: <b><span style="color:red;" id="qrAmount"></span></b> </li>
                    <li>Nội dung chuyển khoản: <b><span style="color:red;" id="qrContent"></span></b> </li>
                    <li>Tên chủ tài khoản: <b><span style="color:red;">Lê Đức Hiếu</span></b> </li>
                    <li>Số tài khoản: <b><span style="color:red;">0336687454</span></b></li>
                    <li><b><span style="color:red;">Ngân hàng Quân đội </span></b></li>
                </ul>

                <h3 style="color:red;">Chú ý mỗi mã QRCode chỉ chuyển 1 lần duy nhất</h3>
                <p>
                    Nếu chuyển thủ công điền sai thông tin chuyển khoản hoặc chuyển nhiều lần cùng 1 mã giao dịch, hệ thống sẽ
                </p>
                <ul>
                    <li><strong>không</strong> cộng tiền vào tài khoản của quý khách</li>
                    <li><strong>không</strong> hoàn trả tiền</li>
                    <li><strong>không</strong> chịu trách nhiệm về khoản tiền chuyển nhầm hoặc chuyển thừa</li>
                </ul>
                <h4>
                    Vui lòng chờ đợi 1 vài phút để hệ thống cập nhật số dư sau khi đã chuyển khoản.<br>
                </h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
    function payButtonClick() {
        var amount = document.querySelector("#amount").value;
        var info = "Hehe";
        var vietQrUrl = "https://img.vietqr.io/image/MB-0336687454-compact.png?accountName=LE%20DUC%20HIEU";
        vietQrUrl += "&amount=" + amount.replaceAll(",", "");
        vietQrUrl += "&addInfo=" + info;

        var img = `<img src='` + vietQrUrl + `' alt="QR Thanh toán" style="display: block; margin-left: auto; margin-right: auto; width: 50%;">`;
        $(document).ready(function () {
            document.getElementById("qrCode").innerHTML = img;
            document.getElementById("qrAmount").innerHTML = amount + " VND";
            document.getElementById("qrContent").innerHTML = info;
        });

    }

    //prevent key
    document.getElementById("amount").addEventListener("keydown", (event) => {
        var amount = document.getElementById("amount").value;

        var acceptedKeyCode = [
            48,49,50,51,52,53,54,55,56,57,58,96,97,98,99,100,101,102,103,104,105,8
        ];

        if (!acceptedKeyCode.includes(event.keyCode)) {
            event.preventDefault()
            return;
        }
        
        
    });

    function inputAmount(){
        var amount = document.querySelector("#amount").value;
        amount = amount.replaceAll(",", "");
        
        if(amount.length === 0 || parseInt(amount) < 10000){
            amount = "10,000";
            document.querySelector("#amount").value = amount;
            return;
        }
        var formatVND = formatStringToCurrencyVND(amount);
        document.querySelector("#amount").value = formatVND;
    }

    function formatStringToCurrencyVND(number){
        var length = number.length;
        var count = 0;
        var result = "";
        const chars = number.split('');
        if (length % 3 === 0) {
            count = -1;
        } else {
            count = 0;
        }
        for (let i = length - 1; i >= 0; i--) {
            if ((i + 1) % 3 === 0) {
                count++
            }
        }
        var result = number.split("");
        var mod = number.length % 3;
        var positions = [];
        for (let i = 0; i <= count; i++) {
            if (mod % 3 === 0) {
                var position = 0;
                if (i === 0) continue;
                if (i === 1) {
                    position = i * 3;
                } else {
                    position = i * 3 + i - 1;
                }
                positions.push(position);
            } else {
                if (i === count) continue;
                var position = 0;
                if (i === 0) {
                    position = i * 3 + mod
                } else {
                    position = i * 3 + mod + i
                }
                positions.push(position);
            }
        }
        for (let i = 0; i < positions.length; i++) {
            var array = [","];
            result = result.concat(array);
            if (mod % 3 === 0) {
                var temp = result[positions[i]];
                for (let j = result.length - 1; j >= 0; j--) {
                    if (j >= positions[i]) {
                        result[j] = result[j - 1]
                    }
                }
                result[positions[i] - 1] = temp;
                result[positions[i]] = ",";
            } else {
                var temp = result[0];
                for (let j = result.length - 1; j > mod; j--) {
                    if (j >= positions[i]) {
                        result[j] = result[j - 1]
                    }
                }

                result[positions[i]] = ",";
            }


        }
        var x = "";
        for (let i = 0; i < result.length; i++) {
            x += result[i];
        }
        return x;
    }

    function formatCurrencyVndToString(number){
        return number.replaceAll(",","");
    }

</script>

