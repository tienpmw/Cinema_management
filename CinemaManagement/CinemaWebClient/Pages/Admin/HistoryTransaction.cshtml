@page
@model CinemaWebClient.Pages.Admin.HistoryTransactionModel
@{
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}


<div style="display:flex; margin-bottom:50px">
    <i class="fa-solid fa-landmark" style="font-size:50px; margin-right:5px"></i>
    <h1>History Transaction</h1>
</div>

<div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-4">
        <div class="d-flex mt-10">
            <label class="form-label" style="width:15%"><b>ID</b></label>
            <input id="txtSearchById" class="form-control" type="text" />
        </div>
        <div class="d-flex mt-10">
            <label class="form-label" style="width:15%"><b>Email</b></label>
            <input id="txtSearchByEmail" class="form-control" type="text" />
        </div>
        <div class="d-flex mt-10">
            <label class="form-label" style="width:15%"><b>Status</b></label>
            <select id="txtSearchByStatus" class="form-control">
                <option value="-1" selected>Select option</option>
                <option value="1">Paid</option>
                <option value="0">UnPaid</option>
            </select>
        </div>
        <button class="btn btn-primary" style="margin-top:15px; margin-left: 80%;" onclick="Search()">Search</button>
    </div>
</div>

<hr />

<div class="userTable" style="margin-top:30px;">
    <table id="myTable" class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Request Date</th>
                <th>Code</th>
                <th>Amount</th>
                <th>Paid Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="tableContent">
            <tr>
                <td>1</td>
                <td>hieuldhe150703@gmail.com</td>
                <td>10/06/2023</td>
                <td>XJKSAOAWD</td>
                <td>10,000 VND</td>
                <td>-</td>
                <td style="color:red">UnPaid</td>
            </tr>

        </tbody>
    </table>
</div>


<script>
    $(document).ready(function () {
        $('#myTable').DataTable({
            "searching": false,
            "lengthChange": false,
            "info": false,
            "ordering": true,
        });

        LoadData('http://localhost:5001/api/Transactions?$expand=User&$orderby=RequestDate,PaidDate');

    });

    function LoadData(link) {
        var tableContent = document.getElementById('tableContent');
        tableContent.innerHTML = "";
        $.ajax({
            url: link,
            type: 'GET',
            data: {

            },
            success: (data) => {
                var tr = '';
                for (var i = 0; i < data.length; i++) {

                    var formatAmount = formatStringToCurrencyVND(data[i].Amount + "");
                    var status = data[i].IsPay === true ? "Paid" : "UnPaid";
                    tr +=
                        `
                        <tr>
                            <td>${data[i].Id}</td>
                            <td>${data[i].User.Email}</td>
                        `;
                    tr+=
                        `
                            <td>${data[i].RequestDate}</td>
                        `;
                    tr+=
                        `
                            <td>${data[i].Code}</td>
                        `;

                    tr+=        
                        `
                            <td>${formatAmount}đ</td>
                        `;
                    tr+=
                        `
                            <td>${data[i].PaidDate}</td>
                        `;
                    if (data[i].IsPay === true){
                        tr +=
                            `
                                <td style='color:green'><b>${status}</n></td>
                            `;
                    }else{
                        tr +=
                            `
                                <td style='color:red'><b>${status}</n></td>
                            `;
                    }
                    
                    tr+=
                        `
                        </tr>
                        `;
                }
                tableContent.innerHTML = tr;
            },
            error: (err) => {
                alert("worng");
            }
        });
    }

    var querySearch = "http://localhost:5001/api/Transactions?$expand=User & $orderby=RequestDate,PaidDate & ";
    function Search() {
        var valueID = document.getElementById("txtSearchById").value;
        var valueEmail = document.getElementById("txtSearchByEmail").value;
        var rawValueStautus = document.getElementById("txtSearchByStatus").value;
      

        var query = "";
        query += MakeQueryConditionContainStringCastingNumToString("Id", valueID, true);
        query += MakeQueryConditionContainString("User/Email", valueEmail, false);
        if(rawValueStautus != -1){
            query += MakeQueryEqual("IsPay", rawValueStautus === '1', false);
        }
        LoadData(querySearch + query);
    }
   

    function Delete(id) {
        $.ajax({
            url: "http://localhost:5049/api/Book/" + id,
            type: 'DELETE',
            success: (data) => {
                document.getElementById("dataRow-" + id).innerHTML = "";
                NotificationMessageSuccess(data);
            },
            error: (xhr, status, error) => {
                NotificationMessageError(xhr.responseText);
                //JSON.parse(xhr.responseText).error;
            }
        });
    }
</script>

<style>
    .userTable {
        width: 90%;
        margin: 0 auto;
    }

    .create-link {
        margin-left: 10%;
    }
    .mt-10{
        margin-top:10px;
    }
</style>
