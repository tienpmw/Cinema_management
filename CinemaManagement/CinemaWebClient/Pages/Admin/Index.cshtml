@page
@model CinemaWebClient.Pages.Admin.IndexModel
@{
	Layout = "~/Pages/Shared/_AdminLayout.cshtml";
	string accessToken = await Util.GetAccessToken(HttpContext);
}

<div class="loading" id="loading">
	<div class="spinner"></div>
</div>
<div class="container-fluid">

	<!-- Page Heading -->
	<div class="d-sm-flex align-items-center justify-content-between mb-4">
		<h1 class="h3 mb-0 text-gray-800" style="text-shadow: 0px 5px 70px gray; font-weight: 700;">Dashboard</h1>
		@*<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
			<i class="fas fa-download fa-sm text-white-50"></i> Generate Report
		</a>*@
	</div>

	<!-- Content Row -->
	<div class="row">

		<!-- Earnings (Monthly) Card Example -->
		<div class="col-xl-6 col-md-6 mb-4">
			<div class="card border-left-primary shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
								Earnings (Monthly)
							</div>
							<div class="h5 mb-0 font-weight-bold text-gray-800">@(ViewBag.EarningMonthly) VNĐ</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-calendar fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Earnings (Monthly) Card Example -->
		<div class="col-xl-6 col-md-6 mb-4">
			<div class="card border-left-success shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-success text-uppercase mb-1">
								Earnings (Annual)
							</div>
							<div class="h5 mb-0 font-weight-bold text-gray-800">@(ViewBag.EarningAnnual) VNĐ</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Earnings (Monthly) Card Example -->
		@*<div class="col-xl-3 col-md-6 mb-4">
			<div class="card border-left-info shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-info text-uppercase mb-1">
								Tasks
							</div>
							<div class="row no-gutters align-items-center">
								<div class="col-auto">
									<div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">50%</div>
								</div>
								<div class="col">
									<div class="progress progress-sm mr-2">
										<div class="progress-bar bg-info" role="progressbar"
											 style="width: 50%" aria-valuenow="50" aria-valuemin="0"
											 aria-valuemax="100"></div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Pending Requests Card Example -->
		<div class="col-xl-3 col-md-6 mb-4">
			<div class="card border-left-warning shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
								Pending Requests
							</div>
							<div class="h5 mb-0 font-weight-bold text-gray-800">18</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-comments fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>*@
	</div>

	<!-- Content Row -->

	<div class="row">

		<!-- Area Chart -->
		<div class="col-xl-12 col-lg-12">
			<div class="card shadow mb-4">
				<!-- Card Header - Dropdown -->
				<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
					<h5 class="m-0 font-weight-bold text-primary">Earnings Overview</h5>
					<div class="dropdown no-arrow">
						<a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
						   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
						</a>
						<div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
							 aria-labelledby="dropdownMenuLink">
							<div class="dropdown-header">Dropdown Header:</div>
							<a class="dropdown-item" href="#">Action</a>
							<a class="dropdown-item" href="#">Another action</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="#">Something else here</a>
						</div>
					</div>
				</div>
				<!-- Card Body -->
				<div class="card-body">
					<div class="chart-area">
						<canvas id="myAreaChart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<!-- Pie Chart -->
		@*<div class="col-xl-4 col-lg-5">
			<div class="card shadow mb-4">
				<!-- Card Header - Dropdown -->
				<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
					<h6 class="m-0 font-weight-bold text-primary">Revenue Sources</h6>
					<div class="dropdown no-arrow">
						<a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
						   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
						</a>
						<div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
							 aria-labelledby="dropdownMenuLink">
							<div class="dropdown-header">Dropdown Header:</div>
							<a class="dropdown-item" href="#">Action</a>
							<a class="dropdown-item" href="#">Another action</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="#">Something else here</a>
						</div>
					</div>
				</div>
				<!-- Card Body -->
				<div class="card-body">
					<div class="chart-pie pt-4 pb-2">
						<canvas id="myPieChart"></canvas>
					</div>
					<div class="mt-4 text-center small">
						<span class="mr-2">
							<i class="fas fa-circle text-primary"></i> Direct
						</span>
						<span class="mr-2">
							<i class="fas fa-circle text-success"></i> Social
						</span>
						<span class="mr-2">
							<i class="fas fa-circle text-info"></i> Referral
						</span>
					</div>
				</div>
			</div>
		</div>*@
	</div>

	<div class="row">
		<div class="col-xl-12 col-lg-12">
			<div class="card shadow mb-4">
				<!-- Card Header - Dropdown -->
				<div class="card-header py-3 d-flex flex-row align-items-center">
					<h5 class="m-0 font-weight-bold text-primary">Statistics In </h5>
					<div class="row" style="margin-left:10px; margin-top:10px">
						<div class='col-sm-5'>
							<div class="form-group">
								<div class='input-group date'>
									<input type='date' class="form-control" id='startDate' />
									<span class="input-group-addon">
										<span class="glyphicon glyphicon-calendar"></span>
									</span>
								</div>
							</div>
						</div>
						<div class="col-sm-1"><p>-</p></div>
						<div class='col-sm-5'>
							<div class="form-group">
								<div class='input-group date'>
									<input type='date' class="form-control" id='endDate' />
									<span class="input-group-addon">
										<span class="glyphicon glyphicon-calendar"></span>
									</span>
								</div>
							</div>
						</div>
					</div>
					<button type="button" class="btn btn-primary" onclick="GetReport()">Get report</button>
				</div>
				<!-- Card Body -->
				<div class="card-body" id="bodyStatic">
					<h6><b>I. List of shows:</b></h6>
					<div class="table-responsive">
						<table class="table table-bordered" id="myTable" width="100%" cellspacing="0">
							<thead>
								<tr>
									<th style="width:10%">No.</th>
									<th style="width:20%">Date</th>
									<th style="width:25%">Film's title'</th>
									<th style="width:24%">Room</th>
									<th style="width:10%">Number seats sold</th>
									<th style="width:10%">Total seats</th>
								</tr>
							</thead>
							<tbody id="tableContent"></tbody>
						</table>
					</div>
					<h6><b>II. Other info:</b></h6>
					<p>1.Revenue: <span id="revenue"></span> VND</p>
					<p>2.Number of movies shown: <span id="totalFilmPublished"></span></p>
					<p>3.Number of screening rooms created: <span id="totalShowCreated"></span></p>
					<p>4.Sold seats/total vacancy ratio: <span id="percentageSoldTicketWithTotalTicket"></span>%</p>
					<p>5.Total amount of money users have recharge into the application: <span id="totalAmountUserRecharge"></span> VND</p>
					<div class="d-flex justify-content-end">
						<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter" style="margin-right:10%;">
							<i class="fa-solid fa-file-arrow-down"></i> Download
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>


<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLongTitle">Download Report</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<i>Are you sure to download this report?</i>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" onclick="DownLoadReport()">
					<i class="fa-solid fa-file-arrow-down"></i> Download
				</button>
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<link href="~/css/loading.css" rel="stylesheet" />

<!-- 
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>


-->


<script>
	$(document).ready(function () {
		SwitchLoading(false);
		document.getElementById("bodyStatic").style.display = "none";
	});

	function SwitchLoading(isDisplay){
		var loading = document.getElementById("loading");
		loading.style.display = (isDisplay === true ? "block" : "none");
	}
	function DownLoadReport(){
		if (document.getElementById('startDate').value === "" || document.getElementById('endDate').value === ""){
			NotificationMessageError("Date must be not empty!");
			return;
		}
		var startDate = new Date(document.getElementById('startDate').value).getTime();
		var endDate = new Date(document.getElementById('endDate').value).getTime();
		if(startDate > endDate){
			NotificationMessageError("Start date must less than end date!");
			return;
		}

		SwitchLoading(true);
		var modal = document.getElementById("exampleModalCenter");
		var modalBackground = document.getElementsByClassName("modal-backdrop")[0];
		modalBackground.style.display = "none";
		modal.style.display = "none";

		$.ajax({
			url: "http://localhost:5001/api/ExportExcel/DataShows",
			type: 'POST',
			data: {
				startDate: document.getElementById('startDate').value,
				endDate: document.getElementById('endDate').value
			},
			xhrFields: {
				responseType: 'blob' // Tell jQuery to expect a binary response (BLOB)
			},
			success: (data, textStatus, xhr) => {
				setTimeout(function () {
					SwitchLoading(false)
				}, 2000);
				// Get the filename from the response headers
				var start = document.getElementById('startDate').value;
				var end = document.getElementById('endDate').value;
				const filename = `Bang_Thong_Ke_${start}_${end}.xlsx`;

				//Convert the Byte Data to BLOB object.
				var blob = new Blob([data], { type: "application/octetstream" });

				// Check the Browser type and download the File.
				var url = window.URL || window.webkitURL;
				link = url.createObjectURL(blob);
				var a = $("<a />");
				a.attr("download", filename);
				a.attr("href", link);
				$("body").append(a);
				a[0].click();
				$("body").remove(a);
			},
			error: (xhr, textStatus, error) => {
				setTimeout(function () {
					SwitchLoading(false)
				}, 1000);
				NotificationMessageError(xhr.responseText);
			}
		});
	}

	function GetReport(){
		if (document.getElementById('startDate').value === "" || document.getElementById('endDate').value === "") {
			NotificationMessageError("Date must be not empty!");
			return;
		}
		var startDate = new Date(document.getElementById('startDate').value).getTime();
		var endDate = new Date(document.getElementById('endDate').value).getTime();
		if (startDate > endDate) {
			NotificationMessageError("Start date must less than end date!");
			return;
		}

		document.getElementById("bodyStatic").style.display = "block";

		SwitchLoading(true);

		$.ajax({
			url: "http://localhost:5001/api/ReportData/GetReportCompanyInRangeTime",
			type: 'POST',
			data: {
				startDate: document.getElementById('startDate').value,
				endDate: document.getElementById('endDate').value
			},
			success: (data, textStatus, xhr) => {
				setTimeout(function () {
					SwitchLoading(false)
				}, 2000);
				LoadDataReport(data);
			},
			error: (xhr, textStatus, error) => {
				setTimeout(function () {
					SwitchLoading(false)
				}, 1000);
				document.getElementById("bodyStatic").style.display = "none";
				NotificationMessageError(xhr.responseText);
			}
		});
	}


	function LoadDataReport(data) {
		var tableContent = document.getElementById('tableContent');
		var initedDataTable = tableContent.innerHTML != "";
		tableContent.innerHTML = "";
		var tr = '';
		var shows = data.shows;
		for (var i = 0; i < shows.length; i++) {
			tr +=
				`
				<tr>
					<td>${shows[i].index}</td>
					<td>${shows[i].date}</td>
					<td>${shows[i].title}</td>
					<td>${shows[i].room}</td>
					<td>${shows[i].numberTicketSold}</td>
					<td>${shows[i].totalTicket}</td>
				</tr>
				`;
		}
		tableContent.innerHTML += tr;
		if (!initedDataTable) {
			$(document).ready(function () {
				$('#myTable').DataTable({
					pagingType: 'full',
					"lengthChange": false,
					searching: false,
					"bDestroy": true
				});
			});
		}
		$("#revenue").html(formatStringToCurrencyVND(data.revenue + ""));
		$("#totalFilmPublished").html(data.totalFilmPublished);
		$("#totalShowCreated").html(data.totalShowCreated);
		$("#percentageSoldTicketWithTotalTicket").html(data.percentageSoldTicketWithTotalTicket);
		$("#totalAmountUserRecharge").html(formatStringToCurrencyVND(data.totalAmountUserRecharge + ""));
	}
	
</script>


<!-- /.container-fluid -->
@section Scripts {
	<!-- Core plugin JavaScript-->
	<script src="~/vendor/jquery-easing/jquery.easing.min.js"></script>
	<script>
		var token = '@accessToken';
	</script>
	
	<!-- Custom scripts for all pages-->
	<script src="~/js/sb-admin-2.min.js"></script>
	<script src="~/js/site.js"></script>

	<!-- Page level plugins -->
	<script src="~/vendor/chart.js/Chart.min.js"></script>
	<!-- Page level custom scripts -->
	<script src="~/js/demo/chart-area-demo.js"></script>
	<script src="~/js/demo/chart-pie-demo.js"></script>
}